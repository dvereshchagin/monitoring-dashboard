name: GitOps Update Staging

on:
  push:
    branches: [main]

permissions:
  contents: write
  id-token: write

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}

jobs:
  build-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: monitoring-dashboard-api/go.mod

      - name: Unit tests
        working-directory: monitoring-dashboard-api
        run: go test -v ./...

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_REPO="${{ steps.login-ecr.outputs.registry }}/${ECR_REPOSITORY}"

          # Build main API image
          docker build -f monitoring-dashboard-api/Dockerfile \
            -t "${IMAGE_REPO}:${IMAGE_TAG}" \
            -t "${IMAGE_REPO}:latest" \
            monitoring-dashboard-api

          # Push images
          docker push "${IMAGE_REPO}:${IMAGE_TAG}"
          docker push "${IMAGE_REPO}:latest"

          # Export for next steps
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "$GITHUB_ENV"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update Helm values
        run: |
          HELM_VALUES="infra/helm/monitoring-dashboard/values-staging.yaml"

          # Update image tag in Helm values
          yq eval '.image.tag = env(IMAGE_TAG)' -i "$HELM_VALUES"

          # Show the changes
          echo "Updated values:"
          git diff "$HELM_VALUES"

      - name: Commit and push image tag update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add infra/helm/monitoring-dashboard/values-staging.yaml

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore(gitops): update staging image to ${IMAGE_TAG}

Built from commit: ${{ github.sha }}
Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git push

      - name: Deployment summary
        run: |
          echo "âœ… Image built and pushed successfully"
          echo "âœ… Helm values updated in Git"
          echo ""
          echo "ðŸ“¦ Image Tag: ${IMAGE_TAG}"
          echo "ðŸ”— ECR: ${{ steps.login-ecr.outputs.registry }}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo ""
          echo "Next steps:"
          echo "  1. Verify image in ECR"
          echo "  2. Deploy to staging using Helm"
          echo "  3. Verify deployment: kubectl -n monitoring-dashboard get pods"
